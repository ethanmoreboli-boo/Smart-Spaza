{% extends "base.html" %}

{% block title %}SmartSpaza - Developer Dashboard{% endblock %}

{% block head %}
<style>
/* Base layout */
:root {
  --primary: #2563eb;       /* blue */
  --primary-dark: #1e40af;
  --accent: #4CAF50;        /* green */
  --bg: #f8fafc;            /* light background */
  --text: #0f172a;          /* dark text */
  --card-bg: #ffffff;
  --shadow: rgba(0,0,0,0.08);
}

body {
  font-family: 'Segoe UI', sans-serif;
  color: var(--text);
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #89daff 0%, #d1f2d7 100%);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Page title */
h1.page-title {
  text-align: center;
  margin: 20px 0;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--accent);
}

/* Navigation bar */
.nav-bar {
  display: flex;
  justify-content: center;
  gap: 20px;
  background: var(--card-bg);
  padding: 12px 20px;
  box-shadow: 0 2px 6px var(--shadow);
  border-radius: 8px;
  margin: 0 auto 20px;
  max-width: 1200px;
}
.nav-bar a {
  text-decoration: none;
  font-size: 1rem;
  color: var(--primary);
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 6px;
  transition: background-color 0.2s ease, color 0.2s ease;
}
.nav-bar a:hover {
  background-color: var(--primary);
  color: #fff;
}

/* Summary cards */
.summary {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto 30px auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
}
.summary div {
  background-color: var(--card-bg);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 10px var(--shadow);
  text-align: center;
  transition: transform 0.2s ease;
}
.summary div:hover {
  transform: translateY(-5px);
}
.summary h3 {
  margin: 10px 0;
  color: var(--text);
  font-size: 1.1rem;
}
.summary p {
  font-size: 1.4rem;
  font-weight: 600;
  color: var(--accent);
}

/* Charts grid */
.charts {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto 30px auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  text-align: center;
}
.charts h4 {
  margin-bottom: 10px;
  font-size: 1rem;
  color: var(--text);
}
.charts canvas {
  max-width: 220px;
  max-height: 220px;
  margin: 0 auto;
}

/* Back button */
.back {
  display: block;
  text-align: center;
  margin: 20px auto;
  padding: 10px 18px;
  text-decoration: none;
  color: var(--primary);
  border: 1px solid var(--primary);
  border-radius: 6px;
  transition: 0.2s;
  max-width: 200px; 
}
.back:hover {
  background-color: var(--primary);
  color: white;
}

/* Toast messages */
#toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
}
.toast-message {
  background: var(--card-bg);
  padding: 10px 15px;
  margin-top: 10px;
  border-radius: 6px;
  box-shadow: 0 2px 6px var(--shadow);
  font-size: 0.9rem;
}

.nav-bottom {
    display: flex;
    justify-content: center;
    flex-wrap: wrap; 
    margin-top: 50px;
}
.nav-bottom a {
    text-decoration: none;
    color: #000000;
    border: 2px solid #007bff;
    padding: 10px 20px;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.nav-bottom a:hover { background-color: #69a2de; color: rgb(69, 84, 245); }


/* Responsive tweaks */
@media (max-width: 1024px) {
  h1.page-title { font-size: 1.6rem; }
  .charts canvas { max-width: 180px; max-height: 180px; }
}
@media (max-width: 768px) {
  h1.page-title { font-size: 1.4rem; }
  .summary { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
  .charts { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
  .charts canvas { max-width: 160px; max-height: 160px; }
}
@media (max-width: 480px) {
  h1.page-title { font-size: 1.2rem; }
  .summary div { padding: 15px; }
  .back { width: 90%; }
  .charts canvas { max-width: 140px; max-height: 140px; }
}

</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Developer Dashboard</h1>

<!-- Navigation Bar -->
<nav class="nav-bar">
  <a href="{{ url_for('account_management') }}">Manage Accounts</a>
  <a href="{{ url_for('transactions') }}">Transactions</a>
</nav>

<!-- Summary Boxes -->
<div class="summary">
    <div>
        <h3>Total Owners</h3>
        <p>{{ total_owners }}</p>
    </div>
    <div>
        <h3>Active Accounts</h3>
        <p>{{ active_accounts }}</p>
    </div>
    <div>
        <h3>Blocked Accounts</h3>
        <p>{{ blocked_accounts }}</p>
    </div>
    <div>
        <h3>Owners Paid This Month</h3>
        <p>{{ owners_paid }}</p>
    </div>
</div>

<!-- Pie Charts in one row (responsive) -->
<div class="charts">
    <div>
        <h4>Top 5 Performing Owners</h4>
        <canvas id="topOwnersChart"></canvas>
    </div>
    <div>
        <h4>Payment Compliance</h4>
        <canvas id="complianceChart"></canvas>
    </div>
    <div>
        <h4>Monthly Registrations vs Attrition</h4>
        <canvas id="registrationChart"></canvas>
    </div>
    <div>
        <h4>Owner Registration Growth</h4>
        <canvas id="growthChart"></canvas>
    </div>
</div>

<div class="nav-bottom">
    <a href="{{ url_for('logout') }}"> Logout</a>
</div>

<!-- Toast Container -->
<div id="toast-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="toast-message {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Toast fade effect
window.addEventListener('DOMContentLoaded', () => {
    const toasts = document.querySelectorAll('#toast-container .toast-message');
    toasts.forEach(toast => {
        toast.style.opacity = 1;
        toast.style.transform = "translateY(-10px)";
        setTimeout(() => {
            toast.style.opacity = 0;
            toast.style.transform = "translateY(0px)";
        }, 3000);
    });
});

// Helper: convert raw counts to percentages
function toPercentages(dataArray) {
    const total = dataArray.reduce((sum, val) => sum + val, 0);
    return dataArray.map(val => total ? ((val / total) * 100).toFixed(2) : 0);
}

// Data from Flask
const topOwnersData = {{ top_owners|tojson }};
const complianceData = {{ compliance|tojson }};
const registrationData = {
    registered: {{ registered_this_month }},
    left: {{ left_this_month }}
};
const growthData = {{ growth|tojson }};

// Common legend style (small squares)
const legendStyle = {
    position: 'right',
    labels: {
        boxWidth: 12,   // ✅ small square width
        boxHeight: 12,  // ✅ small square height
        padding: 8,
        font: { size: 12 }
    }
};

// Top 5 Owners Chart (percentages only)
new Chart(document.getElementById('topOwnersChart'), {
    type: 'pie',
    data: {
        labels: topOwnersData.map(o => `${o.username} `),
        datasets: [{
            data: topOwnersData.map(o => o.progress),
            backgroundColor: ['#4CAF50','#2196F3','#FFC107','#FF5722','#9C27B0']
        }]
    },
    options: {
        plugins: {
            legend: legendStyle,
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.label}`;
                    }
                }
            }
        }
    }
});

// Payment Compliance Chart
const complianceCounts = complianceData.map(c => c.count);
const compliancePercents = toPercentages(complianceCounts);

new Chart(document.getElementById('complianceChart'), {
    type: 'pie',
    data: {
        labels: complianceData.map((c) => `${c.status} `),
        datasets: [{
            data: compliancePercents,
            backgroundColor: ['#28a745','#dc3545']
        }]
    },
    options: { plugins: { legend: legendStyle } }
});

// Registration vs Attrition Chart
const regCounts = [registrationData.registered, registrationData.left];
const regPercents = toPercentages(regCounts);

new Chart(document.getElementById('registrationChart'), {
    type: 'pie',
    data: {
        labels: ['Stayed','Left'].map((lbl, i) => `${lbl} `),
        datasets: [{
            data: regPercents,
            backgroundColor: ['#007bff','#6c757d']
        }]
    },
    options: { plugins: { legend: legendStyle } }
});

// Growth Chart
const growthCounts = growthData.map(g => g.registrations);
const growthPercents = toPercentages(growthCounts);

new Chart(document.getElementById('growthChart'), {
    type: 'pie',
    data: {
        labels: growthData.map((g, i) => `${g.quarter} `),
        datasets: [{
            data: growthPercents,
            backgroundColor: ['#17a2b8','#ffc107','#28a745','#dc3545']
        }]
    },
    options: { plugins: { legend: legendStyle } }
});
</script>
{% endblock %}
