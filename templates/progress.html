{% extends "base.html" %}

{% block title %}Business Progress - SmartSpaza{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>

body {
  background-color: #a7caff;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}


header {
  background-color: #00695c;
  padding: 10px 20px;
}

.navbar {
    padding: 0px 20px;
  display: flex;
  color: #ffffff;
  justify-content: space-between;
  align-items: center;
}


.brand {
  font-weight: bold;
  font-size: 20px;
  color: #fff;
  margin: 0;
}

/* Nav links */
.nav-links {
  list-style: none;
  display: flex;
  gap: 20px;
  margin: 0;
  padding: 0;
}

.nav-links a {
  color: #fff;
  text-decoration: none;
  font-size: 18px;
  transition: color 0.3s;
}

.nav-links a:hover {
  color: #ffc107;
}

/* Cards */
.card {
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  transition: transform 0.3s, box-shadow 0.3s;
  margin-bottom: 20px;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

/* Chart container */
.chart-container {
  position: relative;
  height: 350px;
  width: 100%;
  max-width: 1000px;
  margin: 0 auto;
  background-image: url('/static/images/trends-bg.svg');
  background-size: cover;
  background-position: center;
}

/* Progress bar */
.progress {
  height: 30px;
  border-radius: 20px;
  overflow: hidden;
}

.progress-bar {
  transition: width 1.5s ease-in-out, background-color 0.5s;
}

/* Low stock alerts */
.low-stock {
  background-color: #ffe6e6 !important;
  font-weight: bold;
  color: #d32f2f;
}

/* Toast messages */
.toast-message {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(50px);
  z-index: 9999;
  padding: 12px 25px;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  opacity: 0;
  transition: all 0.5s;
  text-align: center;
  max-width: 90%;
}

.toast-success { background-color: #28a745; }
.toast-warning { background-color: #ffc107; color: #333; }
.toast-danger { background-color: #d32f2f; }

/* Responsive adjustments */
@media (max-width: 768px) {
  .chart-container {
    height: 280px;
    padding: 0 10px;
  }
  .progress {
    height: 24px;
  }
  .card {
    margin: 10px;
  }
  .navbar {
    flex-direction: column;
    align-items: flex-start;
  }
  .nav-links {
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }
}

@media (max-width: 480px) {
  .chart-container {
    height: 220px;
  }
  .progress {
    height: 20px;
  }
  .toast-message {
    font-size: 13px;
    padding: 10px 18px;
  }
  .brand {
    font-size: 16px;
  }
  .nav-links a {
    font-size: 14px;
  }
}


</style>
{% endblock %}

{% block content %}
<header class="navbar">
    <h1>SmartSpaza</h1>
    
    <ul class="nav-links">
      <a href="{{ url_for('owner_details') }}" >üë§ Profile</a>
      <a href="{{ url_for('report_default') }}" >üìã Report</a>
    </ul>
  
</header>


<div class="container my-5">
    <h2 class="text-center mb-4 fw-bold text-success"> Business Progress </h2>

    <!-- Milestone Toast -->
    {% if milestone_message %}
        <div class="toast-message toast-success">{{ milestone_message }}</div>
    {% endif %}

    <!-- Low Stock Alert -->
    {% if low_stock_products %}
        <div class="toast-message toast-danger">
            ‚ö†Ô∏è Low stock for: {{ ", ".join(low_stock_products) }}
        </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header bg-primary text-white fw-semibold">üìà Weekly Sales Trends</div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="weeklySalesChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white fw-semibold">üèÜ Top 6 Products</div>
        <div class="card-body">
            {% if top_products %}
            <div class="chart-container mb-4">
                <canvas id="topProductsChart"></canvas>
            </div>
            <table class="table table-striped align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>Product</th>
                        <th>Quantity Sold</th>
                        <th>Revenue (R)</th>
                        <th>Profit (R)</th>
                        <th>Stock</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in top_products %}
                    <tr class="{{ 'low-stock' if p.stock < 7 else '' }}">
                        <td>{{ p.name }}</td>
                        <td>{{ p.sold }}</td>
                        <td>{{ "%.2f"|format(p.revenue) }}</td>
                        <td>{{ "%.2f"|format(p.profit) }}</td>
                        <td>{{ p.stock }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p class="text-muted text-center">No sales data yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- üéØ Monthly Revenue Target -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-white fw-semibold">üéØ Monthly Revenue Target</div>
        <div class="card-body">
            <div class="progress mb-2">
                <div class="progress-bar bg-warning" role="progressbar" 
                     style="width: {{ monthly_progress }}%;">
                    {{ monthly_progress }}%
                </div>
            </div>
            <p class="text-center">
                R{{ "%.2f"|format(current_revenue) }} / R{{ "%.2f"|format(target_revenue) }}
            </p>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary px-4 py-2">‚¨Ö Back to Dashboard</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
    Chart.register(ChartZoom);

    // Weekly Sales Chart
    const weeklySalesData = {{ weekly_sales|tojson }};
    const weeks = weeklySalesData.map(item => item.week);
    const avgPrices = weeklySalesData.map(item => item.avg_price);
    const weeklyRevenue = weeklySalesData.map(item => item.revenue);

    const ctxWeekly = document.getElementById('weeklySalesChart').getContext('2d');
    const weeklyChart = new Chart(ctxWeekly, {
        type: 'line',
        data: {
            labels: weeks,
            datasets: [
                {
                    label: 'Average Price (R)',
                    data: avgPrices,
                    borderColor: '#0072ff',
                    backgroundColor: 'rgba(0,114,255,0.2)',
                    tension: 0.4,
                    fill: false,
                    yAxisID: 'y'
                },
                {
                    label: 'Weekly Revenue (R)',
                    data: weeklyRevenue,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40,167,69,0.2)',
                    tension: 0.3,
                    fill: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Weekly Price & Revenue Trends' },
                zoom: {
                    pan: { enabled: true, mode: 'x' }, // mouse drag + touch swipe
                    zoom: {
                        wheel: { enabled: true }, // scroll wheel zoom
                        pinch: { enabled: true }, // pinch zoom on mobile
                        mode: 'x'
                    }
                }
            },
            scales: {
                x: {
                    min: weeks.length > 10 ? weeks.length - 10 : 0,
                    max: weeks.length - 1,
                    title: { display: true, text: 'Week Number' }
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Average Price (R)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Revenue (R)' }
                }
            }
        }
    });

    // Cursor-aware keyboard activation
    const chartCanvas = document.getElementById('weeklySalesChart');
    let chartFocused = false;
    chartCanvas.addEventListener('mouseenter', () => { chartFocused = true; });
    chartCanvas.addEventListener('mouseleave', () => { chartFocused = false; });

    window.addEventListener('keydown', (e) => {
        if (!chartFocused) return;
        const scale = weeklyChart.scales.x;
        const range = scale.max - scale.min;
        if (e.key === 'ArrowLeft') {
            scale.min = Math.max(0, scale.min - 1);
            scale.max = Math.max(range, scale.max - 1);
            weeklyChart.update();
        }
        if (e.key === 'ArrowRight') {
            scale.min = Math.min(weeks.length - range, scale.min + 1);
            scale.max = Math.min(weeks.length - 1, scale.max + 1);
            weeklyChart.update();
        }
    });

    // Top 6 Products Chart
    const topProductsData = {{ top_products|tojson }};
    const productNames = topProductsData.map(p => p.name);
    const productRevenue = topProductsData.map(p => p.revenue);
    const productProfit = topProductsData.map(p => p.profit);

    const ctxProducts = document.getElementById('topProductsChart').getContext('2d');
    new Chart(ctxProducts, {
        type: 'bar',
        data: {
            labels: productNames,
            datasets: [
                {
                    label: 'Revenue (R)',
                    data: productRevenue,
                    backgroundColor: '#4CAF50'
                },
                {
                    label: 'Profit (R)',
                    data: productProfit,
                    backgroundColor: '#FFC107'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                title: { display: true, text: 'Top 6 Products by Revenue & Profit' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Value (R)' }
                }
            }
        }
    });
</script>
{% endblock %}